<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ruota della Fortuna</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ruota">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3798/3798313.png">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            overflow: hidden;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin-bottom: 30px;
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border: 5px solid #fff;
        }

        .segment {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 50%;
            transform-origin: 0% 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .segment span {
            position: absolute;
            left: 20px;
            bottom: 10px;
            transform-origin: 0 0;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* 10 segments, 36 degrees each */
        .segment:nth-child(1) { transform: rotate(0deg) skewY(-54deg); background: #FF5733; }
        .segment:nth-child(2) { transform: rotate(36deg) skewY(-54deg); background: #33FF57; }
        .segment:nth-child(3) { transform: rotate(72deg) skewY(-54deg); background: #3357FF; }
        .segment:nth-child(4) { transform: rotate(108deg) skewY(-54deg); background: #F333FF; }
        .segment:nth-child(5) { transform: rotate(144deg) skewY(-54deg); background: #FF3333; }
        .segment:nth-child(6) { transform: rotate(180deg) skewY(-54deg); background: #33FFF5; }
        .segment:nth-child(7) { transform: rotate(216deg) skewY(-54deg); background: #F5FF33; }
        .segment:nth-child(8) { transform: rotate(252deg) skewY(-54deg); background: #FF8C33; }
        .segment:nth-child(9) { transform: rotate(288deg) skewY(-54deg); background: #8C33FF; }
        .segment:nth-child(10) { transform: rotate(324deg) skewY(-54deg); background: #33FF8C; }

        /* Fix text rotation inside segments */
        .segment span {
            transform: skewY(54deg) rotate(18deg);
            margin-top: 40px;
            margin-left: 20px;
        }

        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #333;
            z-index: 10;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #result {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            height: 30px;
        }

        #installBtn {
            display: none; /* Hidden by default */
            background-color: #008CBA;
            margin-top: 20px;
        }

        /* iOS Install Instructions Modal */
        #ios-install-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            text-align: center;
            z-index: 1000;
            box-sizing: border-box;
        }
        
        #ios-install-modal p {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1rem;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
    </style>
</head>
<body>

    <h1>Ruota della Fortuna</h1>

    <div class="wheel-container">
        <div class="pointer"></div>
        <div class="wheel" id="wheel">
            <!-- Segments 1-10 -->
            <!-- Note: The visual order goes clockwise. 1 is at 0-36 deg (top rightish) -->
            <div class="segment"><span>1</span></div>
            <div class="segment"><span>2</span></div>
            <div class="segment"><span>3</span></div>
            <div class="segment"><span>4</span></div>
            <div class="segment"><span>5</span></div>
            <div class="segment"><span>6</span></div>
            <div class="segment"><span>7</span></div>
            <div class="segment"><span>8</span></div>
            <div class="segment"><span>9</span></div>
            <div class="segment"><span>10</span></div>
        </div>
    </div>

    <button id="spinBtn">GIRA!</button>
    <div id="result"></div>

    <button id="notifyBtn" style="background-color: #ff9800; display: block; margin: 10px auto;">ðŸ”” Attiva Notifiche (Debug)</button>

    <!-- OneSignal Bell replaces the custom checkbox -->

    <button id="installBtn">ðŸ“² Installa App</button>

    <!-- iOS Instructions -->
    <div id="ios-install-modal">
        <span class="close-modal" onclick="document.getElementById('ios-install-modal').style.display='none'">&times;</span>
        <p>Per installare su iPhone/iPad:</p>
        <p>1. Tocca il pulsante <strong>Condividi</strong> <img src="https://img.icons8.com/ios/50/000000/upload.png" style="width:20px; vertical-align:middle;"></p>
        <p>2. Scorri e seleziona <strong>"Aggiungi alla schermata Home"</strong> âž•</p>
    </div>

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        
        // Setup Notify Button Logic
        const notifyBtn = document.getElementById('notifyBtn');

        OneSignalDeferred.push(async function(OneSignal) {
             await OneSignal.init({
                 appId: "3cc59c8b-c638-4137-893f-1bef78fc6e0c",
                 serviceWorkerParam: { scope: '/' },
                 serviceWorkerPath: 'OneSignalSDKWorker.js',
             });
             
             // Check if already subscribed
             const isPushSupported = OneSignal.Notifications.isPushSupported();
             const permission = OneSignal.Notifications.permission;
             
             console.log("Push Supported:", isPushSupported);
             console.log("Current Permission:", permission);
             
             // Aggressive Reconnect Logic
             if (permission === 'granted') {
                 console.log("Permission granted, forcing login...");
                 // Force login to refresh session
                 OneSignal.login(OneSignal.User.PushSubscription.id || "unknown_user");
                 
                 // Opt-in again just to be sure
                 OneSignal.User.PushSubscription.optIn();
             }
            
            // alert(`DEBUG: Supporto Push: ${isPushSupported} | Permesso: ${permission}`);

            // Always show button for debugging
            // notifyBtn.style.display = 'inline-block';

            // Handle button click
            notifyBtn.addEventListener('click', async () => {
                console.log("Requesting permission...");
                try {
                    // Step 1: Request Permission
                    await OneSignal.Notifications.requestPermission();
                    
                    // Step 2: Check result
                    const perm = OneSignal.Notifications.permission;
                    
                    if (perm === 'granted') {
                        // Step 3: Wait for subscription ID (Push Token)
                        // Sometimes permission is granted but subscription fails (e.g. no internet/blocked)
                        alert("Permesso OK. Attendo registrazione...");
                        
                        // Try to get user ID
                        const userId = OneSignal.User.PushSubscription.id;
                        if (userId) {
                            alert(`SUCCESSO! ID Utente: ${userId}`);
                        } else {
                            // Subscribe explicitly
                            OneSignal.User.PushSubscription.optIn();
                            
                            // Wait a bit and check again
                            setTimeout(() => {
                                const newId = OneSignal.User.PushSubscription.id;
                                if (newId) {
                                    alert(`SUCCESSO DOPO ATTESA! ID: ${newId}`);
                                } else {
                                    alert("ATTENZIONE: Permesso dato, ma ID Utente nullo. Probabile errore di rete o Service Worker non caricato.");
                                }
                            }, 3000);
                        }
                    } else {
                        alert(`Permesso negato o chiuso: ${perm}`);
                    }

                } catch (e) {
                    console.error("Permission request failed", e);
                    alert("ERRORE GRAVE: " + JSON.stringify(e));
                }
            });
        });
        
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spinBtn');
        const resultDiv = document.getElementById('result');
        let currentRotation = 0;

        spinBtn.addEventListener('click', () => {
            // Disable button during spin
            spinBtn.disabled = true;
            resultDiv.textContent = '';

            // Random spin: at least 5 full rotations (1800 deg) + random 0-360
            const randomDegrees = Math.floor(Math.random() * 360);
            const totalSpin = 1800 + randomDegrees;
            
            currentRotation += totalSpin;
            
            wheel.style.transform = `rotate(-${currentRotation}deg)`; // Rotate counter-clockwise so numbers go clockwise past the pointer

            setTimeout(() => {
                spinBtn.disabled = false;
                calculateResult(currentRotation);
            }, 4000); // Matches CSS transition time
        });

        function calculateResult(rotation) {
            // Normalize rotation to 0-360
            const actualRotation = rotation % 360;
            
            // Pointer is at the top (0 degrees or 360)
            // If wheel rotates counter-clockwise by X degrees, the segment at X degrees passes the pointer.
            // Segments are 36 degrees each.
            // 0-36 deg = 1
            // 36-72 deg = 2
            // etc.
            
            const segmentIndex = Math.floor(actualRotation / 36);
            // Since segments are 1-based in our logic but 0-based in index calculation
            // And our CSS places 1 at 0-36, 2 at 36-72...
            // If we rotate -30 deg, we are at 30 deg in the wheel coordinates.
            
            let result = segmentIndex + 1;
            
            // Fix for edge case 360
            if (result > 10) result = 1;

            resultDiv.textContent = `Hai vinto il premio numero: ${result}! ðŸŽ‰`;
        }

        // PWA Installation Logic
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        const iosModal = document.getElementById('ios-install-modal');

        // Detect iOS
        const isIos = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }

        // Detect if app is in standalone mode
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

        // Show iOS instructions if appropriate
        if (isIos() && !isInStandaloneMode()) {
            // Show instructions after a short delay
            setTimeout(() => {
                iosModal.style.display = 'block';
            }, 1000);
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', (e) => {
            // Hide our user interface that shows our A2HS button
            installBtn.style.display = 'none';
            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                deferredPrompt = null;
            });
        });

        // REMOVED OLD LOCAL NOTIFICATION & SERVICE WORKER LOGIC
        // OneSignal handles both Service Worker registration and Notifications now.
        
    </script>
</body>
</html>
